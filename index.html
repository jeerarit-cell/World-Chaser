<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WORLD CHASER - SMART CONTRACT READY</title>
    
    <script src="https://unpkg.com/@worldcoin/idkit-standalone"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

    <style>
        :root { --neon: #FF9500; --neon-hot: #FF5E00; --bg: #0a0a0c; --card: #1a1a1e; --border: #2d2d33; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { position: fixed; overflow: hidden; width: 100%; height: 100%; margin: 0; padding: 0; background: var(--bg); color: white; font-family: -apple-system, sans-serif; }
        .news-ticker { background: #000; color: var(--neon); padding: 7px 0; font-size: 0.75rem; border-bottom: 1px solid var(--neon-hot); overflow: hidden; }
        .ticker-text { display: inline-block; animation: ticker 25s linear infinite; padding-left: 100%; white-space: nowrap; }
        @keyframes ticker { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        .screen { display: none; height: 100vh; flex-direction: column; width: 100%; max-width: 500px; margin: 0 auto; background: radial-gradient(circle at top, #2b1a0a 0%, #0a0a0c 100%); position: relative; }
        .active { display: flex; }
        .room-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; margin: 15px 0; }
        .room-btn { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 12px; color: #555; cursor: pointer; text-align: center; }
        .room-btn b { display: block; font-size: 1.2rem; }
        .room-btn.selected { border-color: var(--neon); background: rgba(255,149,0,0.15); color: var(--neon); }
        .top-nav { display: flex; justify-content: space-between; padding: 10px 15px; background: rgba(0,0,0,0.8); align-items: center; border-bottom: 1px solid var(--border); }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px 15px; }
        .stat-card { background: var(--card); border: 1px solid var(--border); padding: 8px; border-radius: 10px; text-align: center; font-size: 0.65rem; color: #777; }
        .stat-card b { color: var(--neon); font-size: 0.85rem; display: block; }
        .board-container { padding: 0 15px 10px 15px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
        .slot { aspect-ratio: 1/1; background: #0e0e10; border: 1px solid #1f1f23; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #333; transition: 0.3s; overflow: hidden; }
        .slot.active-chaser { border-color: var(--neon); box-shadow: 0 0 12px var(--neon-hot); background: rgba(255, 149, 0, 0.2); color: white !important; font-weight: bold; }
        .main-content { display: flex; padding: 0 15px 10px 15px; gap: 10px; }
        .left-panel { flex: 1.6; display: flex; flex-direction: column; gap: 6px; }
        .chat-section { height: 320px; border: 2px solid #ffffff; border-radius: 18px; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; overflow: hidden; }
        #chatBox { flex: 1; padding: 10px; overflow-y: auto; font-size: 0.8rem; }
        .chat-input-row { padding: 8px 12px; background: #000; border-top: 1px solid var(--border); }
        .chat-input-row input { width: 100%; background: transparent; border: none; color: var(--neon); }
        .menu-section { flex: 1; display: flex; flex-direction: column; gap: 8px; height: 360px; }
        .btn-play-action { flex: 2; background: linear-gradient(145deg, #ff9500, #ff5e00); border: none; color: #000; border-radius: 15px; font-size: 1.2rem; font-weight: 900; }
    </style>
</head>
<body>

<div class="news-ticker">
    <div class="ticker-text" id="tickerText">üî• WORLD CHASER: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ World ID ‡πÅ‡∏•‡∏∞‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Smart Contract ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!</div>
</div>

<div id="lobby" class="screen active">
    <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px;">
        <h1 style="color:#fff; font-size: 2.4rem; margin: 0;">WORLD CHASER</h1>
        <input type="text" id="userNameInp" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô..." maxlength="12" style="width:100%; padding:15px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,0.05); color:white; margin:20px 0; text-align:center;">
        <div class="room-grid">
            <div class="room-btn selected" onclick="selectRoom(0.001, this)"><b>0.001</b><span>WLD</span></div>
            <div class="room-btn" onclick="selectRoom(0.01, this)"><b>0.01</b><span>WLD</span></div>
        </div>
        <button onclick="joinGame()" style="width:100%; padding:18px; background:var(--neon); border:none; border-radius:15px; font-weight:900; color:#000;">VERIFY WORLD ID</button>
    </div>
</div>

<div id="game" class="screen">
    <div class="top-nav">
        <b id="headerPlayerName">PLAYER</b>
        <div id="roomTag" style="color:var(--neon); font-weight:bold;">WLD 0.001</div>
    </div>
    <div class="stats-grid">
        <div class="stat-card">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (WLD)<br><b id="prizeDisplay">0.0000</b></div>
        <div class="stat-card">‡πÄ‡∏ß‡∏•‡∏≤<br><b id="timer">WAIT</b></div>
        <div class="stat-card">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô<br><b id="pCountTop">0/12</b></div>
    </div>
    <div class="board-container" id="board"></div>
    <div class="main-content">
        <div class="left-panel">
            <div class="chat-section">
                <div id="chatBox"></div>
                <div class="chat-input-row"><input type="text" id="chatInp" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeydown="if(event.key==='Enter') sendMsg()"></div>
            </div>
        </div>
        <div class="menu-section">
            <button class="btn-play-action" id="btnPlay" onclick="play()">PLAY</button>
        </div>
    </div>
</div>

<script>
    // --- 2. CONFIGURATION ---
    const APP_ID = "app_7a67630a2166eba727b9b283105535";
    const ACTION_ID = "join-game";
    const SERVER_URL = "https://your-socket-server.render.com"; 
    const CONTRACT_ADDRESS = "0xE2d2e88CadDeE4508152972CA8183b654311b144";
    const CONTRACT_ABI = [
        "function depositEntry() external payable",
        "function getBalance() public view returns (uint256)"
    ];

    let socket, provider, signer, userWallet;
    let currentPlayerName = "GUEST", players = [], hasJoined = false;
    let ENTRY_FEE = 0.001, audioCtx;

    // --- 3. WEB3 & PAYMENT ---
    async function initWeb3() {
        if (window.ethereum) {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userWallet = await signer.getAddress();
            return true;
        }
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á MetaMask ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App");
        return false;
    }

    async function requestPayment() {
        try {
            if (!signer) await initWeb3();
            const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            const amountInWei = ethers.parseUnits(ENTRY_FEE.toString(), 18);
            
            addChat("SYSTEM", "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤...", "color:#FF9500");
            const tx = await contract.depositEntry({ value: amountInWei });
            await tx.wait();
            
            addChat("SYSTEM", "‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "color:#00FF00");
            return true;
        } catch (e) {
            addChat("ERROR", "‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "color:red");
            return false;
        }
    }

    // --- 4. GAME FLOW ---
    async function joinGame() {
        const name = document.getElementById('userNameInp').value.trim();
        if (!name) return alert("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô");
        if (!(await initWeb3())) return;

        try {
            const result = await IDKit.verify({
                app_id: APP_ID,
                action: ACTION_ID,
                signal: userWallet, 
            });

            if (result) {
                currentPlayerName = name;
                document.getElementById('headerPlayerName').innerText = currentPlayerName.toUpperCase();
                document.getElementById('lobby').classList.remove('active');
                document.getElementById('game').classList.add('active');
                initSocket();
            }
        } catch (e) { alert("Verification ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); }
    }

    async function play() {
        if(hasJoined) return;
        const paid = await requestPayment();
        if(paid) {
            hasJoined = true;
            document.getElementById('btnPlay').disabled = true;
            if(socket) socket.emit("joinQueue", { name: currentPlayerName, wallet: userWallet, fee: ENTRY_FEE });
        }
    }

    // --- 5. UTILS ---
    function initSocket() {
        socket = io(SERVER_URL);
        socket.on("updatePlayers", (pList) => { players = pList; updateBoard(); });
        socket.on("startSpin", (winIdx) => runGame(winIdx));
    }

    function updateBoard() {
        const b = document.getElementById('board'); b.innerHTML = "";
        for(let i=0; i < 12; i++){
            const s = document.createElement('div'); s.className = 'slot';
            if(players[i]) { s.innerText = players[i].name.substring(0,5); s.style.borderColor = "var(--neon)"; }
            b.appendChild(s);
        }
        document.getElementById('pCountTop').innerText = `${players.length}/12`;
    }

    function addChat(u, m, s='') {
        const b = document.getElementById('chatBox');
        b.innerHTML += `<div><b style="${s}">${u}:</b> <span>${m}</span></div>`;
        b.scrollTop = b.scrollHeight;
    }

    function selectRoom(f, btn) {
        ENTRY_FEE = f;
        document.querySelectorAll('.room-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }
</script>
</body>
</html>
