<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WORLD CHASER PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@latest/dist/minikit.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --neon: #ff9500; --bg: #050b18; --glass: rgba(255, 255, 255, 0.03); }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        body { margin: 0; background: var(--bg); color: white; font-family: -apple-system, system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .screen { display: none; flex: 1; flex-direction: column; align-items: center; padding: 25px; transition: opacity 0.5s ease; }
        .active { display: flex; }

        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° */
        .status-card { width: 100%; background: var(--glass); border: 1px solid rgba(255,149,0,0.2); border-radius: 20px; padding: 15px; margin-bottom: 25px; backdrop-filter: blur(10px); }
        .status-item { display: flex; justify-content: space-between; font-size: 0.85rem; margin: 5px 0; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .red { background: #ff4b4b; box-shadow: 0 0 10px #ff4b4b; }
        .green { background: #00ff88; box-shadow: 0 0 10px #00ff88; }

        /* ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏Å‡∏° */
        .board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; width: 100%; max-width: 450px; margin: 20px 0; }
        .slot { aspect-ratio: 1; background: var(--glass); border: 1.5px solid rgba(255,255,255,0.1); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; transition: 0.2s; }
        .slot.active-chaser { background: var(--neon); color: black; box-shadow: 0 0 25px var(--neon); border-color: white; transform: scale(1.08); font-weight: bold; }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î */
        .btn-pro { width: 100%; padding: 20px; background: var(--neon); border: none; border-radius: 18px; color: black; font-size: 1.2rem; font-weight: 800; cursor: pointer; transition: 0.3s; box-shadow: 0 8px 20px rgba(255,149,0,0.2); }
        .btn-pro:disabled { filter: grayscale(1); opacity: 0.3; }
    </style>
</head>
<body>

<div id="auth-screen" class="screen active">
    <h1 style="color:var(--neon); margin-top:40px; font-size: 2.2rem; letter-spacing: 2px;">WORLD CHASER</h1>
    <div class="status-card">
        <div class="status-item"><span>MiniKit SDK:</span> <span id="st-sdk"><span class="dot red"></span>‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î</span></div>
        <div class="status-item"><span>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô:</span> <span id="st-wallet"><span class="dot red"></span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span></div>
        <div class="status-item"><span>‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå:</span> <span id="st-socket"><span class="dot red"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span></div>
    </div>
    <button id="entryBtn" class="btn-pro" disabled onclick="enterLobby()">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...</button>
</div>

<div id="main-screen" class="screen">
    <div style="width:100%; display:flex; justify-content:space-between; font-weight:bold; color:var(--neon);">
        <span onclick="location.reload()">EXIT</span>
        <span id="roomTitle">ROOM 0.001 WLD</span>
    </div>
    <h2 id="countdown" style="font-size: 3.5rem; margin: 15px 0;">READY</h2>
    <div class="board" id="gameBoard"></div>
    <div style="margin-bottom: 20px; font-size: 1.1rem; opacity:0.8;">POOL: <span id="poolValue" style="color:#00ff88">0.00</span> WLD</div>
    <button class="btn-pro" onclick="requestPayment()">PLAY (SIGN TX)</button>
</div>

<script>
    const socket = io();
    let myWallet = "";
    let roomPrice = "0.001";
    let audioCtx = null;

    // --- üü¢ ‡∏£‡∏∞‡∏ö‡∏ö Pro Connect ---
    async function startProInit() {
        try {
            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö MiniKit
            window.MiniKit.install();
            document.getElementById('st-sdk').innerHTML = '<span class="dot green"></span>‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß';

            // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Socket
            socket.on('connect', () => {
                document.getElementById('st-socket').innerHTML = '<span class="dot green"></span>‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
                checkFinalStatus();
            });

            // 3. ‡∏£‡∏∞‡∏ö‡∏ö Retry Wallet (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ)
            const walletTrigger = setInterval(() => {
                if (window.MiniKit.walletAddress) {
                    myWallet = window.MiniKit.walletAddress;
                    document.getElementById('st-wallet').innerHTML = '<span class="dot green"></span>' + myWallet.substring(0,8);
                    checkFinalStatus();
                    clearInterval(walletTrigger);
                }
            }, 800);

        } catch (err) { console.error("Init Error", err); }
    }

    function checkFinalStatus() {
        if (myWallet && socket.connected) {
            const btn = document.getElementById('entryBtn');
            btn.disabled = false;
            btn.innerHTML = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏ô‡∏≤‡∏°‡∏•‡πà‡∏≤ (PRO)";
            socket.emit('auth_user', { wallet: myWallet, username: "P_" + myWallet.substring(2,6) });
        }
    }

    function enterLobby() {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.getElementById('auth-screen').classList.remove('active');
        document.getElementById('main-screen').classList.add('active');
        socket.emit('join_room', { room: roomPrice, wallet: myWallet });
        drawBoard([]);
    }

    // --- üü¢ ‡∏£‡∏∞‡∏ö‡∏ö Pro Gameplay ---
    async function requestPayment() {
        try {
            const res = await window.MiniKit.commands.pay({
                reference: "pro_" + Date.now(),
                to: "0xe20a539852fa7ea1dc943683edb89b6b95ec54a8",
                tokens: [{ symbol: "WLD", amount: roomPrice }],
                description: "World Chaser Pro Stake"
            });
            if (res.finalPayload.status === "success") {
                socket.emit('player_paid', { room: roomPrice, wallet: myWallet, txHash: res.finalPayload.transaction_id });
            }
        } catch (e) { console.warn("User Canceled"); }
    }

    function drawBoard(players) {
        const board = document.getElementById('gameBoard');
        board.innerHTML = "";
        for(let i=0; i<12; i++) {
            const cell = document.createElement('div');
            cell.className = 'slot';
            if(players[i]) {
                cell.innerHTML = `<b>${players[i].username}</b>${players[i].isReady ? '<br>üü¢' : ''}`;
                if(players[i].isReady) cell.style.borderColor = "var(--neon)";
            } else { cell.style.opacity = "0.3"; cell.innerText = "EMPTY"; }
            board.appendChild(cell);
        }
        const readyCount = players.filter(p => p.isReady).length;
        document.getElementById('poolValue').innerText = (readyCount * parseFloat(roomPrice) * 0.85).toFixed(4);
    }

    // --- üü¢ ‡∏£‡∏∞‡∏ö‡∏ö Pro FX ---
    socket.on('update_players', (data) => drawBoard(data));
    socket.on('timer_update', (t) => { document.getElementById('countdown').innerText = t + "s"; });
    socket.on('game_result', (data) => {
        let count = 0;
        let speed = 80;
        let anim = setInterval(() => {
            const slots = document.querySelectorAll('.slot');
            slots.forEach(s => s.classList.remove('active-chaser'));
            slots[count % 12].classList.add('active-chaser');
            
            // Pro Sound Tick
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.frequency.value = 1500; g.gain.value = 0.02;
            osc.start(); osc.stop(audioCtx.currentTime + 0.02);

            count++;
            if(count > 36) { 
                clearInterval(anim);
                alert("üéâ WINNER: " + data.winner + "\n‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: " + data.prize.toFixed(4) + " WLD");
            }
        }, speed);
    });

    window.onload = startProInit;
</script>
</body>
</html>
