<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WORLD CHASER - ULTIMATE CASINO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@latest/dist/minikit.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        :root { --neon: #ff9500; --neon-blue: #00e5ff; --bg-overlay: rgba(5, 11, 24, 0.85); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: url('https://images.unsplash.com/photo-1614850523296-d8c1af93d400?q=80&w=2070') no-repeat center center fixed;
            background-size: cover; color: white; overflow: hidden;
        }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-overlay); backdrop-filter: blur(8px); }

        .container { position: relative; z-index: 10; max-width: 500px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }

        /* --- ‡∏´‡∏ô‡πâ‡∏≤ Lobby (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á) --- */
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; }
        .active { display: flex; }

        .room-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        .room-card { 
            background: rgba(255,255,255,0.1); border: 2px solid var(--border); border-radius: 15px; padding: 20px; 
            text-align: center; cursor: pointer; transition: 0.3s; 
        }
        .room-card:active { transform: scale(0.95); background: var(--neon); color: black; }
        .room-card.selected { border-color: var(--neon); box-shadow: 0 0 15px var(--neon); }

        /* --- ‡∏´‡∏ô‡πâ‡∏≤ Game (‡∏ö‡∏≠‡∏£‡πå‡∏î 12 ‡∏ä‡πà‡∏≠‡∏á) --- */
        .board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; background: rgba(0,0,0,0.4); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .slot { 
            aspect-ratio: 1/1; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); 
            border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 0.6rem; text-align: center; transition: all 0.1s; 
        }
        
        /* ‡πÑ‡∏ü‡∏ß‡∏¥‡πà‡∏á */
        .slot.chasing { background: var(--neon); color: black; box-shadow: 0 0 25px var(--neon); border-color: white; transform: scale(1.1); z-index: 5; }
        .slot.winner { animation: flash 0.3s infinite alternate; color: black; font-weight: bold; }
        @keyframes flash { from { background: #fff; } to { background: var(--neon); } }

        .btn-pay { width: 100%; padding: 18px; margin-top: 20px; border: none; border-radius: 15px; background: linear-gradient(90deg, var(--neon), #ff5e00); color: white; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(255,149,0,0.3); }
        
        #timer { font-size: 2.5rem; font-weight: 900; text-align: center; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); margin: 10px 0; }
    </style>
</head>
<body>

<div class="overlay"></div>

<div class="container">
    <div id="lobby" class="screen active">
        <h1 style="text-align:center; color:var(--neon); margin-top:50px;">WORLD CHASER</h1>
        <p id="statusTxt" style="text-align:center; font-size:0.8rem; opacity:0.7;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ World ID...</p>
        
        <div class="room-grid">
            <div class="room-card" onclick="selectRoom('0.001')"><h3>0.001</h3><p>WLD</p></div>
            <div class="room-card" onclick="selectRoom('0.01')"><h3>0.01</h3><p>WLD</p></div>
            <div class="room-card" onclick="selectRoom('0.1')"><h3>0.1</h3><p>WLD</p></div>
            <div class="room-card" onclick="selectRoom('1.0')"><h3>1.0</h3><p>WLD</p></div>
        </div>
        <button class="btn-pay" style="margin-top:auto; margin-bottom:40px;" onclick="enterRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    </div>

    <div id="game" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button onclick="location.reload()" style="background:none; border:none; color:white;">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
            <span id="currentRoomDisplay">ROOM: 0.001 WLD</span>
        </div>
        
        <div id="timer">WAITING</div>

        <div class="board" id="board">
            </div>

        <div style="text-align:center; margin:15px 0;">
            <small>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏ô‡∏û‡∏π‡∏•: <span id="poolAmt">0.00</span> WLD</small>
        </div>

        <button class="btn-pay" id="payBtn" onclick="payEntry()">PLAY (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô)</button>
        <div id="log" style="font-size:0.7rem; color:#aaa; margin-top:10px; height:60px; overflow:hidden;"></div>
    </div>
</div>

<script>
    const socket = io();
    let myWallet = "", myName = "", selectedRoom = "0.001", roomPlayers = [];
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
    async function init() {
        window.MiniKit.install();
        await new Promise(r => setTimeout(r, 1500));
        if (window.MiniKit.walletAddress) {
            myWallet = window.MiniKit.walletAddress;
            myName = "Player_" + myWallet.substring(2, 6);
            document.getElementById('statusTxt').textContent = "ID: " + myName;
            socket.emit('auth_user', { wallet: myWallet, username: myName });
        }
    }
    window.onload = init;

    // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á
    function selectRoom(amt) {
        selectedRoom = amt;
        document.querySelectorAll('.room-card').forEach(c => c.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
    }

    function enterRoom() {
        document.getElementById('lobby').classList.remove('active');
        document.getElementById('game').classList.add('active');
        document.getElementById('currentRoomDisplay').textContent = `ROOM: ${selectedRoom} WLD`;
        socket.emit('join_room', { room: selectedRoom, wallet: myWallet });
        renderBoard();
    }

    // 3. ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô MiniKit
    async function payEntry() {
        try {
            const payload = {
                reference: "chase_" + Date.now(),
                to: "0xe20a539852fa7ea1dc943683edb89b6b95ec54a8", // ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì
                tokens: [{ symbol: "WLD", amount: selectedRoom }],
                description: `‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏´‡πâ‡∏≠‡∏á ${selectedRoom}`
            };
            const { finalPayload } = await window.MiniKit.commands.pay(payload);
            if (finalPayload.status === "success") {
                socket.emit('player_paid', { room: selectedRoom, wallet: myWallet, txHash: finalPayload.transaction_id });
                addLog("‚úÖ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏∏‡∏Å...");
            }
        } catch (e) { addLog("‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô"); }
    }

    // 4. ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô
    function renderBoard() {
        const b = document.getElementById('board');
        b.innerHTML = "";
        for(let i=0; i<12; i++) {
            const s = document.createElement('div');
            s.className = 'slot';
            if(roomPlayers[i]) {
                s.innerHTML = `<b>${roomPlayers[i].username}</b><br>${roomPlayers[i].isReady ? '‚úÖ' : '‚è≥'}`;
                if(roomPlayers[i].isReady) s.style.borderColor = "var(--neon)";
            } else {
                s.innerHTML = `<span style="opacity:0.3">‡∏ß‡πà‡∏≤‡∏á</span>`;
            }
            b.appendChild(s);
        }
    }

    function runWinAnim(data) {
        const slots = document.querySelectorAll('.slot');
        let current = 0;
        let totalSteps = 24 + roomPlayers.findIndex(p => p.wallet === data.wallet);
        let speed = 60;

        function step() {
            slots.forEach(s => s.classList.remove('chasing'));
            const idx = current % 12;
            slots[idx].classList.add('chasing');
            playTick();
            
            current++;
            if (current < totalSteps) {
                if(totalSteps - current < 8) speed += 40;
                setTimeout(step, speed);
            } else {
                slots[idx].classList.add('winner');
                addLog(`üèÜ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ${data.winner} ‡∏ä‡∏ô‡∏∞‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•`);
            }
        }
        step();
    }

    // 5. ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞ Log
    function playTick() {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.connect(g); g.connect(audioCtx.destination);
        osc.frequency.value = 1200; g.gain.value = 0.05;
        osc.start(); osc.stop(audioCtx.currentTime + 0.03);
    }

    function addLog(m) { document.getElementById('log').innerHTML = `> ${m}<br>` + document.getElementById('log').innerHTML; }

    // 6. Socket Events
    socket.on('update_players', (data) => { roomPlayers = data; renderBoard(); });
    socket.on('timer_update', (t) => { document.getElementById('timer').textContent = t + "s"; });
    socket.on('game_result', (data) => { runWinAnim(data); });
</script>
</body>
</html>
